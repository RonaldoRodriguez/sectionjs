"use strict";class SectionJS{constructor(elementOrSelector){this.allData=null;this.data=null;this.scopeDataContext={};this.dataSource=null;this.controlLimit=null;this.controlOrder="ASC";this.controlStart=0;this.controlBy=null;this.controlTotal=null;this.controlResponsePath=null;this.controlFilter=null;this.currentPage=1;this.totalPages=0;this.itemsTotal=0;this.itemsNow=0;this.firstItemIndex=0;this.lastItemIndex=0;this.observer=null;this.observerActive=false;this.isInitializing=true;this.isLogicScopeInstance=false;this.loopDefinitions=new Map;this.initialContainerStructureHTML="";let container=null;if(typeof elementOrSelector==="string"){container=document.querySelector(elementOrSelector);if(!container){throw new Error(`SectionJS: No se encontró el elemento para el selector "${elementOrSelector}".`)}}else if(elementOrSelector instanceof HTMLElement){container=elementOrSelector}else{throw new Error("SectionJS: El constructor requiere un selector de string o un HTMLElement.")}this.articleContainer=container;if(!this.articleContainer.id){this.name=this.generateId()}else{this.name=this.articleContainer.id}const hasDataSrc=this.articleContainer.hasAttribute("data-src");const hasLogicScope=this.articleContainer.hasAttribute("data-logic-scope");if(hasDataSrc){this.isLogicScopeInstance=false;this.dataSource=this.sanitizeURL(this.articleContainer.getAttribute("data-src"))}else if(hasLogicScope){this.isLogicScopeInstance=true;this.dataSource=null;const scopeSrcAttr=this.articleContainer.getAttribute("data-logic-scope");if(scopeSrcAttr&&scopeSrcAttr.trim().startsWith("{")){try{this.scopeDataContext=JSON.parse(scopeSrcAttr)}catch(e){console.warn(`SectionJS (${this.name}): JSON inválido en data-logic-scope. Usando {}.`,e);this.scopeDataContext={}}}else{this.scopeDataContext={}}this.allData=[this.scopeDataContext]}else{this.isLogicScopeInstance=false;this.dataSource=null;this.allData=[]}this.loadConfigFromAttributes();if(SectionJS.supportsFinalizationRegistry&&!SectionJS.finalizationRegistry){SectionJS.finalizationRegistry=new FinalizationRegistry((heldValue=>{SectionJS.instancesRefs=SectionJS.instancesRefs.filter((refOrInstance=>{if(SectionJS.supportsWeakRef&&refOrInstance instanceof WeakRef){return refOrInstance.deref()!==undefined}return true}))}))}this.addInstance(this);this.enableObserver();if(this.dataSource||this.isLogicScopeInstance){this.initialize().catch((error=>{console.error(`SectionJS (${this.name}): Error durante la inicialización automática.`,error)}))}else{this.isInitializing=false;this.captureInitialTemplates();this.updatePaginationState();this.dispatchEvent("sectionjs:rendered",{renderedElements:[],data:[]});this.articleContainer.setAttribute("data-section-rendered","true")}}generateId(){return`sjs-instance-${Math.random().toString(36).substring(2,9)}`}addInstance(instance){if(!SectionJS.instances.includes(instance)){SectionJS.instances.push(instance);if(SectionJS.supportsWeakRef){const ref=new WeakRef(instance);SectionJS.instancesRefs.push(ref);if(SectionJS.finalizationRegistry){SectionJS.finalizationRegistry.register(instance,instance.name,ref)}}else{SectionJS.instancesRefs.push(instance)}}}static stripTemplateCommentsLogic(htmlString){if(!htmlString)return"";const commentRegex=/{\/\*[\s\S]*?\*\/}/g;return htmlString.replace(commentRegex,"")}captureInitialTemplates(){this.loopDefinitions.clear();const clonedContainer=this.articleContainer.cloneNode(true);let loopCounter=0;const processElementForLoopCapture=currentElement=>{const children=Array.from(currentElement.children);for(const child of children){if(child instanceof HTMLElement){if(child.hasAttribute("data-logic-each")){const loopElement=child;const directiveValue=loopElement.dataset.logicEach;const templateHTML=SectionJS.stripTemplateCommentsLogic(loopElement.outerHTML);const[loopVarName,dataSourceKey,indexVarName]=this.parseLoopDirective(directiveValue);const placeholderText=`SJS-LOOP-PLACEHOLDER-${this.name}-${loopCounter++}`;const placeholder=document.createComment(placeholderText);this.loopDefinitions.set(placeholder.nodeValue,{templateHTML:templateHTML,loopVarName:loopVarName,indexVarName:indexVarName,dataSourceKey:dataSourceKey});if(loopElement.parentNode){loopElement.parentNode.replaceChild(placeholder,loopElement)}}else{processElementForLoopCapture(child)}}}};processElementForLoopCapture(clonedContainer);this.initialContainerStructureHTML=SectionJS.stripTemplateCommentsLogic(clonedContainer.innerHTML)}parseLoopDirective(directiveValue){const inMatch=directiveValue.match(/^(.*)\s+in\s+(.+)$/);if(!inMatch){console.warn(`SectionJS (${this.name}): Formato de directiva de bucle inválido: "${directiveValue}". Usando "item in _instance.data".`);return["item","_instance.data",undefined]}const loopVarsPart=inMatch[1].trim();const dataSourceKey=inMatch[2].trim();const varParts=loopVarsPart.split(",").map((v=>v.trim()));const loopVarName=varParts[0];const indexVarName=varParts.length>1?varParts[1]:undefined;return[loopVarName,dataSourceKey,indexVarName]}static stripGlobalComments(rootElement=document.body){const walker=document.createTreeWalker(rootElement,NodeFilter.SHOW_TEXT|NodeFilter.SHOW_COMMENT,null);const nodesToRemove=[];const nodesToModify=[];let node;while(node=walker.nextNode()){if(node.nodeType===Node.COMMENT_NODE){const commentNode=node;if(commentNode.nodeValue&&commentNode.nodeValue.trim().startsWith("{/*")&&commentNode.nodeValue.trim().endsWith("*/}")){nodesToRemove.push(commentNode)}}else if(node.nodeType===Node.TEXT_NODE){const textNode=node;const originalValue=textNode.nodeValue;if(originalValue&&originalValue.includes("{/*")){const newValue=SectionJS.stripTemplateCommentsLogic(originalValue);if(newValue!==originalValue){nodesToModify.push({node:textNode,newValue:newValue})}}}}nodesToModify.forEach((mod=>{mod.node.nodeValue=mod.newValue}));nodesToRemove.forEach((node=>{node.parentNode?.removeChild(node)}))}loadConfigFromAttributes(){if(!this.isLogicScopeInstance){this.dataSource=this.sanitizeURL(this.articleContainer.getAttribute("data-src"))}this.controlLimit=this.validateNumber(this.articleContainer.getAttribute("data-control-limit"),"data-control-limit");this.controlOrder=this.articleContainer.getAttribute("data-control-order")?.toUpperCase()||"ASC";this.controlStart=this.validateNumber(this.articleContainer.getAttribute("data-control-start"),"data-control-start")||0;this.controlBy=this.articleContainer.getAttribute("data-control-by");this.controlTotal=this.validateNumber(this.articleContainer.getAttribute("data-control-total"),"data-control-total");this.currentPage=Math.max(1,this.validateNumber(this.articleContainer.getAttribute("data-control-page"),"data-control-page")||1);this.controlResponsePath=this.articleContainer.getAttribute("data-control-response-path");this.controlFilter=this.articleContainer.getAttribute("data-control-filter")}sanitizeURL(url){if(url===null)return null;const trimmedUrl=url.trim();if(trimmedUrl.startsWith("[")&&trimmedUrl.endsWith("]")||trimmedUrl.startsWith("{")&&trimmedUrl.endsWith("}")){return trimmedUrl}return trimmedUrl}validateNumber(value,attributeName){if(value===null)return null;const num=parseInt(value,10);if(isNaN(num)){console.warn(`SectionJS (${this.name}): Valor inválido para ${attributeName}: "${value}". Se esperaba un número.`);return null}return num}static registerHelpers(helpers){for(const[name,fn]of Object.entries(helpers)){SectionJS.registerHelper(name,fn)}}static registerHelper(nameOrObject,fn){if(typeof nameOrObject==="string"&&typeof fn==="function"){SectionJS.helpers[nameOrObject]=fn}else if(typeof nameOrObject==="object"&&nameOrObject!==null){for(const name in nameOrObject){if(Object.prototype.hasOwnProperty.call(nameOrObject,name)&&typeof nameOrObject[name]==="function"){SectionJS.helpers[name]=nameOrObject[name]}}}else{console.warn("SectionJS.registerHelper: Argumentos inválidos.")}}async initialize(){this.isInitializing=true;this.dispatchEvent("sectionjs:beforeLoad");try{if(this.isLogicScopeInstance){const scopeSrcAttr=this.articleContainer.getAttribute("data-logic-scope");if(scopeSrcAttr&&scopeSrcAttr.trim().startsWith("{")){try{const parsedData=JSON.parse(scopeSrcAttr);this.scopeDataContext=typeof parsedData==="object"&&!Array.isArray(parsedData)?parsedData:{};this.allData=[this.scopeDataContext]}catch(e){}}}else if(this.dataSource){const rawData=await this.fetchData();this.processFetchedData(rawData||[])}else{this.allData=[]}if(!Array.isArray(this.allData)){console.warn(`SectionJS (${this.name}): this.allData no es un array después de la carga inicial. Forzando a [].`,this.allData);this.allData=[]}this.captureInitialTemplates();this.dispatchEvent("sectionjs:loaded",{data:this.allData});this.refresh()}catch(error){this.dispatchEvent("sectionjs:loadError",{error:error,message:`Error cargando datos para ${this.name}`});console.error(`SectionJS (${this.name}): Error durante la inicialización.`,error);this.allData=this.isLogicScopeInstance?[this.scopeDataContext]:[];try{this.captureInitialTemplates()}catch(e){}this.refresh()}finally{this.isInitializing=false}}static async initAll(options={}){SectionJS.stripGlobalComments(document.body);const createdInstances=[];const processedContainers=[];const dataDrivenContainers=document.querySelectorAll("[data-src]");for(const container of Array.from(dataDrivenContainers)){if(SectionJS.instances.some((inst=>inst.articleContainer===container)))continue;try{const instance=new SectionJS(container);createdInstances.push(instance);processedContainers.push(container)}catch(error){console.error("SectionJS.initAll: Error creando instancia data-driven:",container,error)}}const scopeContainers=document.querySelectorAll("[data-logic-scope]");for(const container of Array.from(scopeContainers)){if(processedContainers.includes(container)||SectionJS.instances.some((inst=>inst.articleContainer===container)))continue;if(!container.id)container.id=`sjs-scope-${Math.random().toString(36).substring(2,9)}`;try{const instance=new SectionJS(container);createdInstances.push(instance)}catch(error){console.error(`SectionJS.initAll: Error creando instancia data-logic-scope:`,container,error)}}document.dispatchEvent(new CustomEvent("sectionjs:allInitialized",{detail:{instances:createdInstances}}));return createdInstances}applyFiltersAndSort(data){let processedData=[...data];if(this.controlFilter){try{const filterFnOrExpr=this.controlFilter;const baseScope=this.createBaseScope(processedData);if(SectionJS.helpers[filterFnOrExpr]&&typeof SectionJS.helpers[filterFnOrExpr]==="function"){processedData=processedData.filter((item=>SectionJS.helpers[filterFnOrExpr](item,this)))}else{processedData=processedData.filter((item=>{const itemScope=Object.create(baseScope);itemScope.item=item;return this.evaluateExpression(filterFnOrExpr,itemScope)}))}}catch(e){console.error(`SectionJS (${this.name}): Error aplicando filtro "${this.controlFilter}".`,e)}}if(this.controlBy){processedData.sort(((a,b)=>{let valA=this.getValueFromPath(a,this.controlBy);let valB=this.getValueFromPath(b,this.controlBy);const aIsNull=valA===null||valA===undefined;const bIsNull=valB===null||valB===undefined;if(aIsNull&&!bIsNull)return this.controlOrder==="ASC"?1:-1;if(!aIsNull&&bIsNull)return this.controlOrder==="ASC"?-1:1;if(aIsNull&&bIsNull)return 0;if(typeof valA==="string"&&typeof valB==="string"){valA=valA.toLowerCase();valB=valB.toLowerCase()}else if(typeof valA==="number"&&typeof valB==="number"){}else{valA=String(valA);valB=String(valB)}if(valA<valB)return this.controlOrder==="ASC"?-1:1;if(valA>valB)return this.controlOrder==="ASC"?1:-1;return 0}))}return processedData}getValueFromPath(obj,path){if(!path||typeof obj!=="object"||obj===null)return undefined;return path.split(".").reduce(((currentObject,key)=>{if(currentObject===null||currentObject===undefined||typeof currentObject!=="object"){return undefined}return currentObject[key]}),obj)}refresh(forceReload=false){if(this.isInitializing&&!this.articleContainer.hasAttribute("data-section-rendered")){}else if(this.isInitializing){console.warn(`SectionJS (${this.name}): Refresh llamado durante inicialización. Omitiendo.`);return}if(!this.allData&&!this.isLogicScopeInstance){this.data=[];this.updatePaginationState();this.render([]);return}let dataToProcess=this.isLogicScopeInstance?this.allData||[this.scopeDataContext]:this.allData||[];if(!Array.isArray(dataToProcess)&&this.isLogicScopeInstance){dataToProcess=[dataToProcess]}else if(!Array.isArray(dataToProcess)){dataToProcess=[]}const filteredAndSortedData=this.isLogicScopeInstance?dataToProcess:this.applyFiltersAndSort(dataToProcess);this.itemsTotal=filteredAndSortedData.length;const pageSize=this.controlLimit&&this.controlLimit>0?this.controlLimit:this.itemsTotal;this.totalPages=pageSize>0?Math.ceil(this.itemsTotal/pageSize):1;if(this.totalPages===0&&this.itemsTotal>0&&pageSize===0)this.totalPages=1;if(this.totalPages===0&&this.itemsTotal===0)this.totalPages=1;this.currentPage=Math.max(1,Math.min(this.currentPage,this.totalPages||1));const startIndex=(this.currentPage-1)*(pageSize||0)+(this.controlStart||0);const endIndex=pageSize>0?startIndex+pageSize:this.itemsTotal;this.data=this.isLogicScopeInstance?filteredAndSortedData:filteredAndSortedData.slice(startIndex,endIndex);this.updatePaginationState();this.render(this.data);if(!this.isInitializing){this.dispatchEvent("sectionjs:dataChanged",{data:this.data})}if(forceReload&&this.dataSource){this.fetchData().then((rawData=>{this.processFetchedData(rawData);this.updatePaginationState();this.render(this.data||[])})).catch((error=>{console.error("Error al recargar datos:",error)}))}else{this.updatePaginationState();this.render(this.data||[])}}render(pageData){this.dispatchEvent("sectionjs:beforeRender",{data:pageData});this.articleContainer.innerHTML=this.initialContainerStructureHTML;const baseScopeData=this.isLogicScopeInstance?this.allData?this.allData[0]:{}:pageData;this.processNode(this.articleContainer,this.createBaseScope(baseScopeData));this.updatePaginationControls();this.articleContainer.setAttribute("data-section-rendered","true");this.dispatchEvent("sectionjs:rendered",{renderedElements:Array.from(this.articleContainer.children),data:pageData})}createBaseScope(currentPageData){return{_instance:this,helpers:SectionJS.helpers,data:currentPageData}}processNode(node,scope){if(node.nodeType===Node.COMMENT_NODE){const commentNode=node;const loopDef=this.loopDefinitions.get(commentNode.nodeValue);if(loopDef&&node.parentNode){const parentForLoopItems=node.parentNode;const itemsFragment=document.createDocumentFragment();let loopDataArray;try{const evaluatedData=this.evaluateExpression(loopDef.dataSourceKey,scope);loopDataArray=Array.isArray(evaluatedData)?evaluatedData:[]}catch(e){console.error(`SectionJS (${this.name}): Error al evaluar la fuente de datos del bucle "${loopDef.dataSourceKey}" en el scope:`,scope,e);loopDataArray=[]}loopDataArray.forEach(((itemData,index)=>{const itemScope=Object.create(scope);itemScope[loopDef.loopVarName]=itemData;if(loopDef.indexVarName){itemScope[loopDef.indexVarName]=index}if(loopDef.dataSourceKey==="_instance.data"){itemScope["data"]=loopDataArray}const tempDiv=document.createElement("div");tempDiv.innerHTML=loopDef.templateHTML;const loopTemplateElement=tempDiv.firstElementChild;if(loopTemplateElement){const clonedElement=loopTemplateElement.cloneNode(true);clonedElement.removeAttribute("data-logic-each");this.processNode(clonedElement,itemScope);itemsFragment.appendChild(clonedElement)}}));parentForLoopItems.replaceChild(itemsFragment,commentNode);return}}if(node.nodeType===Node.ELEMENT_NODE){const htmlElement=node;if(htmlElement.hasAttribute("data-logic-each")){const directiveValue=htmlElement.dataset.logicEach;const[loopVarName,dataSourceKey,indexVarName]=this.parseLoopDirective(directiveValue);const templateHTML=htmlElement.outerHTML;if(htmlElement.parentNode){const parentForLoopItems=htmlElement.parentNode;const itemsFragment=document.createDocumentFragment();let loopDataArray;try{const evaluatedData=this.evaluateExpression(dataSourceKey,scope);loopDataArray=Array.isArray(evaluatedData)?evaluatedData:[]}catch(e){console.error("Error en dataSource de bucle anidado",e);loopDataArray=[]}loopDataArray.forEach(((itemData,index)=>{const itemScope=Object.create(scope);itemScope[loopVarName]=itemData;if(indexVarName)itemScope[indexVarName]=index;if(dataSourceKey==="_instance.data")itemScope["data"]=loopDataArray;const tempDiv=document.createElement("div");tempDiv.innerHTML=templateHTML;const loopTemplateClone=tempDiv.firstElementChild.cloneNode(true);loopTemplateClone.removeAttribute("data-logic-each");this.processNode(loopTemplateClone,itemScope);itemsFragment.appendChild(loopTemplateClone)}));parentForLoopItems.replaceChild(itemsFragment,htmlElement)}return}const ifConditionAttr=htmlElement.getAttribute("data-logic-if");if(ifConditionAttr){const expressionString=this.extractExpressionString(ifConditionAttr);const shouldRender=this.evaluateExpression(expressionString,scope);if(!shouldRender){htmlElement.remove();return}}const showConditionAttr=htmlElement.getAttribute("data-logic-show");if(showConditionAttr){const expressionString=this.extractExpressionString(showConditionAttr);htmlElement.style.display=this.evaluateExpression(expressionString,scope)?"":"none"}this.processAttributes(htmlElement,scope);Array.from(htmlElement.childNodes).forEach((child=>this.processNode(child,scope)))}else if(node.nodeType===Node.TEXT_NODE){this.processTextNode(node,scope)}}async fetchData(){if(!this.dataSource)return null;const trimmedDataSource=this.dataSource.trim();if(trimmedDataSource.startsWith("[")&&trimmedDataSource.endsWith("]")||trimmedDataSource.startsWith("{")&&trimmedDataSource.endsWith("}")){try{return JSON.parse(trimmedDataSource)}catch(e){console.error(`SectionJS (${this.name}): Error parseando JSON inline de data-src.`,e);throw e}}const response=await fetch(trimmedDataSource);if(!response.ok)throw new Error(`HTTP error! status: ${response.status} for URL: ${trimmedDataSource}`);return await response.json()}processFetchedData(rawData){this.itemsTotal=rawData.length;this.allData=rawData}processAttributes(element,context){const attributesToSet=[];const attributesToRemove=[];for(const attr of Array.from(element.attributes)){if(attr.name.startsWith("data-attr-")){const realAttrName=attr.name.substring("data-attr-".length);const expression=this.extractExpressionString(attr.value);const expressionValue=this.evaluateExpression(expression,context);const booleanAttributes=["disabled","checked","selected","readonly","hidden","multiple","required","open","defer","async","ismap","autoplay","controls","loop","muted","playsinline"];if(booleanAttributes.includes(realAttrName.toLowerCase())){if(expressionValue===true||expressionValue==="true"||expressionValue===""){attributesToSet.push({name:realAttrName,value:""})}else{attributesToRemove.push(realAttrName)}}else if(expressionValue!==null&&expressionValue!==undefined){attributesToSet.push({name:realAttrName,value:String(expressionValue)})}else{attributesToRemove.push(realAttrName)}}else if(attr.name.startsWith("data-logic-on-")){const eventName=attr.name.substring("data-logic-on-".length);const actionExpression=attr.value;if(element._sjs_listeners&&element._sjs_listeners[eventName]){element.removeEventListener(eventName,element._sjs_listeners[eventName])}const eventListener=event=>{const eventScope={...context,event:event,_element:element};this.evaluateExpression(actionExpression,eventScope)};element.addEventListener(eventName,eventListener);if(!element._sjs_listeners){element._sjs_listeners={}}element._sjs_listeners[eventName]=eventListener}else if(attr.name==="data-logic-class"){const expressionString=this.extractExpressionString(attr.value);const classValue=this.evaluateExpression(expressionString,context);if(typeof classValue==="string"){classValue.split(" ").forEach((cls=>{if(cls)element.classList.add(cls)}))}else if(Array.isArray(classValue)){classValue.forEach((cls=>{if(typeof cls==="string"&&cls)element.classList.add(cls)}))}else if(typeof classValue==="object"&&classValue!==null){for(const key in classValue){if(Object.prototype.hasOwnProperty.call(classValue,key)){element.classList.toggle(key,!!classValue[key])}}}}else if(attr.value.includes("{{")&&!attr.name.startsWith("data-")){const newValue=this.interpolateText(attr.value,context);if(newValue!==attr.value){attributesToSet.push({name:attr.name,value:newValue})}}}attributesToRemove.forEach((attrName=>element.removeAttribute(attrName)));attributesToSet.forEach((attr=>element.setAttribute(attr.name,attr.value)))}processTextNode(textNode,context){const originalText=textNode.nodeValue||"";if(originalText.includes("{{")){textNode.nodeValue=this.interpolateText(originalText,context)}}extractExpressionString(value){if(value.startsWith("{{*")&&value.endsWith("*}}")){return value.slice(3,-3).trim()}return value.trim()}interpolateText(text,context){return text.replace(/\{\{\s*(?:(\*)\s*(.*?)\s*\*|(.*?))\s*}}/g,((match,isExprStar,exprContent,simpleVarContent)=>{const expression=isExprStar?exprContent.trim():simpleVarContent.trim();let value;try{value=this.evaluateExpression(expression,context);return value!==null&&value!==undefined?isExprStar?String(value):this.escapeHtml(String(value)):""}catch(e){console.error(`SectionJS (${this.name}): Error evaluando interpolación "${match}"`,e,context);return`[Error: ${match}]`}}))}escapeHtml(unsafe){if(typeof unsafe!=="string"){if(unsafe===null||unsafe===undefined)return"";unsafe=String(unsafe)}const escapeMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return unsafe.replace(/[&<>"']/g,(char=>escapeMap[char]||char))}evaluateExpression(expression,context){const evaluationContext={};let currentProto=Object.getPrototypeOf(context);while(currentProto&&currentProto!==Object.prototype){Object.getOwnPropertyNames(currentProto).forEach((key=>{if(!evaluationContext.hasOwnProperty(key)){evaluationContext[key]=currentProto[key]}}));currentProto=Object.getPrototypeOf(currentProto)}for(const key in context){if(Object.prototype.hasOwnProperty.call(context,key)){evaluationContext[key]=context[key]}}evaluationContext._instance=this;evaluationContext.helpers=SectionJS.helpers;const directInstanceProps={currentPage:this.currentPage,totalPages:this.totalPages,itemsTotal:this.itemsTotal,itemsNow:this.itemsNow,firstItemIndex:this.firstItemIndex,lastItemIndex:this.lastItemIndex};for(const key in directInstanceProps){if(!evaluationContext.hasOwnProperty(key)){evaluationContext[key]=directInstanceProps[key]}}const argNames=Object.keys(evaluationContext);const argValues=argNames.map((key=>evaluationContext[key]));try{const func=new Function(...argNames,`"use strict"; try { return (${expression}); } catch(e) { console.error("Error in expression: ${expression.replace(/"/g,'\\"').replace(/\n/g,"\\n")} with context keys:", Object.keys(this).join(', '), e); return undefined; }`);return func.apply(evaluationContext,argValues)}catch(e){console.error(`SectionJS (${this.name}): Error creando función para expresión "${expression}"`,e,evaluationContext);return undefined}}updatePaginationState(){if(this.dataSource){const pageSize=this.controlLimit||3;this.totalPages=Math.ceil(this.itemsTotal/pageSize);this.currentPage=Math.min(this.currentPage,this.totalPages)}if(!this.data||this.data.length===0){this.itemsNow=0;this.firstItemIndex=0;this.lastItemIndex=0}else{this.itemsNow=this.data.length;const pageSizeForIndex=this.controlLimit&&this.controlLimit>0?this.controlLimit:this.itemsTotal;if(this.itemsTotal>0){this.firstItemIndex=(this.currentPage-1)*pageSizeForIndex+(this.controlStart||0)+1;this.lastItemIndex=this.firstItemIndex+this.itemsNow-1}else{this.firstItemIndex=0;this.lastItemIndex=0}}}updatePaginationControls(){if(this.isLogicScopeInstance||!this.controlLimit||this.controlLimit<=0){this.articleContainer.querySelectorAll('[data-pagination-info], [data-action="prev"], [data-action="next"]').forEach((el=>{if(el.hasAttribute("data-pagination-info"))el.textContent="";if(el.tagName==="BUTTON")el.disabled=true}));return}const paginationScope=this.createBaseScope(this.data||[]);this.articleContainer.querySelectorAll("[data-pagination-info]").forEach((el=>{if(el.dataset.sjsOriginalPaginationInfo===undefined){el.dataset.sjsOriginalPaginationInfo=el.textContent||""}const template=el.dataset.sjsOriginalPaginationInfo;el.textContent=this.interpolateText(template||"",paginationScope)}))}nextPage(){if(this.currentPage<(this.totalPages||1)){this.currentPage++;this.refresh(true);this.dispatchEvent("sectionjs:pageChanged",{page:this.currentPage})}}prevPage(){if(this.currentPage>1){this.currentPage--;this.refresh(true);this.dispatchEvent("sectionjs:pageChanged",{page:this.currentPage})}}setPage(pageNumber){const newPage=Math.max(1,Math.min(pageNumber,this.totalPages||1));if(newPage!==this.currentPage){this.currentPage=newPage;this.refresh();this.dispatchEvent("sectionjs:pageChanged",{page:this.currentPage})}}enableObserver(){if(this.observerActive||this.observer||this.isLogicScopeInstance)return;const attributesToObserve=["data-src","data-control-limit","data-control-order","data-control-start","data-control-by","data-control-total","data-control-page","data-control-response-path","data-control-filter"];this.observer=new MutationObserver((mutations=>{let needsReInitialize=false;let needsRefresh=false;mutations.forEach((mutation=>{if(mutation.type==="attributes"&&mutation.attributeName&&attributesToObserve.includes(mutation.attributeName)){const newValue=this.articleContainer.getAttribute(mutation.attributeName);if(mutation.attributeName==="data-src"){needsReInitialize=true}else{this.updateAttributeValue(mutation.attributeName,newValue);needsRefresh=true}}}));if(needsReInitialize){this.initialize().catch((e=>console.error("Error re-initializing on attribute change",e)))}else if(needsRefresh){this.refresh()}}));this.observer.observe(this.articleContainer,{attributes:true});this.observerActive=true}disableObserver(){if(this.observer){this.observer.disconnect();this.observer=null}this.observerActive=false}updateAttributeValue(attributeName,value){switch(attributeName){case"data-control-limit":this.controlLimit=this.validateNumber(value,attributeName);break;case"data-control-order":this.controlOrder=value?.toUpperCase()||"ASC";break;case"data-control-start":this.controlStart=this.validateNumber(value,attributeName)||0;break;case"data-control-by":this.controlBy=value;break;case"data-control-total":this.controlTotal=this.validateNumber(value,attributeName);break;case"data-control-page":this.currentPage=Math.max(1,this.validateNumber(value,attributeName)||1);break;case"data-control-response-path":this.controlResponsePath=value;break;case"data-control-filter":this.controlFilter=value;break}}setAttribute(attributeName,value){if(value===null){this.articleContainer.removeAttribute(attributeName)}else{this.articleContainer.setAttribute(attributeName,value)}if(!this.observerActive&&attributeName.startsWith("data-control-")){this.updateAttributeValue(attributeName,value);this.refresh()}}dispatchEvent(type,detail={}){const eventDetail={instance:this,...detail};this.articleContainer.dispatchEvent(new CustomEvent(type,{detail:eventDetail,bubbles:true}))}destroy(){this.disableObserver();this.articleContainer.innerHTML=this.initialContainerStructureHTML;this.articleContainer.removeAttribute("data-section-rendered");const index=SectionJS.instances.indexOf(this);if(index>-1)SectionJS.instances.splice(index,1);SectionJS.instancesRefs=SectionJS.instancesRefs.filter((refOrInstance=>{if(SectionJS.supportsWeakRef&&refOrInstance instanceof WeakRef){const instance=refOrInstance.deref();if(!instance||instance===this){if(SectionJS.finalizationRegistry&&instance===this){}return false}return true}else{return refOrInstance!==this}}));this.loopDefinitions.clear();this.allData=null;this.data=null}static destroyAll(){[...SectionJS.instances].forEach((instance=>instance.destroy()))}static forceGarbageCollection(){if(typeof gc==="function"){gc()}else{console.warn("gc() is not available in this environment.")}}}SectionJS.instances=[];SectionJS.helpers={};SectionJS.supportsWeakRef=typeof WeakRef!=="undefined";SectionJS.supportsFinalizationRegistry=typeof FinalizationRegistry!=="undefined";SectionJS.instancesRefs=[];SectionJS.finalizationRegistry=null;if(typeof module!=="undefined"&&module.exports){module.exports=SectionJS}else if(typeof window!=="undefined"){window.SectionJS=SectionJS}
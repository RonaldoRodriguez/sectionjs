"use strict";var t=this&&this.__awaiter||function(t,e,i,a){return new(i||(i=Promise))((function(r,n){function s(t){try{l(a.next(t))}catch(e){n(e)}}function o(t){try{l(a["throw"](t))}catch(e){n(e)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,o)}l((a=a.apply(t,e||[])).next())}))};class SectionJS{constructor(t){if(this.articleTemplate=null,this.infoTemplates=null,this.data=null,this.observer=null,this.observerActive=!1,!t)throw new Error("El contenedor proporcionado no es un elemento válido.");this.articleContainer=t,this.spanElements=[...Array.from(this.articleContainer.querySelectorAll('[data-action="info"], [data-section-action="info"]')),...Array.from(document.querySelectorAll(`[data-target="${this.articleContainer.id}"][data-action="info"], [data-target="${this.articleContainer.id}"][data-section-action="info"]`)),...Array.from(document.querySelectorAll(`[data-target="${this.articleContainer.id}"]`)).flatMap((t=>Array.from(t.querySelectorAll('[data-action="info"], [data-section-action="info"]'))))],this.infoTemplates=this.spanElements.map((t=>t.cloneNode(!0))),this.dataSourceURL=t.getAttribute("data-section"),this.limit=this.validateNumber(t.getAttribute("data-limit"),"data-limit"),this.order=t.getAttribute("data-order")||"ASC",this.start=this.validateNumber(t.getAttribute("data-start"),"data-start")||0,this.orderBy=t.getAttribute("data-by"),this.total=this.validateNumber(t.getAttribute("data-total"),"data-total"),this.defaultPage=Math.max(1,this.validateNumber(t.getAttribute("data-default-page"),"data-default-page")||1),this.currentPage=this.defaultPage,this.responsePath=t.getAttribute("data-response-path"),this.findKey=t.getAttribute("data-find")}enableObserver(){if(this.observerActive)return;this.observer=new MutationObserver((t=>{for(const e of t)"attributes"===e.type&&e.attributeName&&this.handleAttrChange(e.attributeName)})),this.observer.observe(this.articleContainer,{attributes:!0,attributeFilter:["data-find","data-limit","data-order","data-start","data-by","data-total","data-default-page","data-response-path","data-section"],subtree:!1}),this.observerActive=!0}disableObserver(){this.observer&&(this.observer.disconnect(),this.observer=null,this.observerActive=!1)}handleAttrChange(t){this.refresh()}validateNumber(t,e){if(null===t||t===undefined||""===t)return null;const i=Number(t);return isNaN(i)?null:i}load(){return t(this,void 0,void 0,(function*(){if(!this.dataSourceURL)return null;try{const t=yield fetch(this.dataSourceURL);if(!t.ok)throw new Error(`Error: ${t.status}`);const e=t.headers.get("Content-Type");if(null==e?void 0:e.includes("application/json")){const e=yield t.json();let i=this.responsePath?this.getValue(e,this.responsePath):e;return this.data=Array.isArray(i)?i:[i],this.articleContainer.dispatchEvent(new CustomEvent("sectionjs:datachanged",{detail:{data:this.data}})),e}{const e=yield t.text();return this.data=[e],e}}catch(t){throw this.articleContainer.innerHTML="<p>Error al cargar datos.</p>",t}}))}findKeyValue(){return t(this,arguments,void 0,(function*(t=null){if(!this.articleContainer)return;const e=this.articleContainer.getAttribute("data-find"),i=this.articleContainer.getAttribute("data-find-default")||"none";try{if(t||(t=yield this.load()),e){const a=this.getValue(t,e)||i;this.articleContainer.setAttribute("data-find-value",a)}}catch(a){}}))}updateAttrs(){this.dataSourceURL=this.articleContainer.getAttribute("data-section"),this.limit=this.validateNumber(this.articleContainer.getAttribute("data-limit"),"data-limit"),this.order=this.articleContainer.getAttribute("data-order")||"ASC",this.start=this.validateNumber(this.articleContainer.getAttribute("data-start"),"data-start")||0,this.orderBy=this.articleContainer.getAttribute("data-by"),this.total=this.validateNumber(this.articleContainer.getAttribute("data-total"),"data-total"),this.defaultPage=Math.max(1,this.validateNumber(this.articleContainer.getAttribute("data-default-page"),"data-default-page")||1),this.responsePath=this.articleContainer.getAttribute("data-response-path"),this.findKey=this.articleContainer.getAttribute("data-find")}getPage(t){var e,i;if(!this.data)return[];let a=this.data;Array.isArray(a)&&this.orderBy&&(a=a.slice().sort(((t,e)=>{const i=this.getValue(t,this.orderBy),a=this.getValue(e,this.orderBy);return"asc"===this.order.toLowerCase()?i<a?-1:1:i>a?-1:1})));const r=null!==(e=this.limit)&&void 0!==e?e:a.length,n=(t-1)*r+this.start,s=Math.min(n+r,null!==(i=this.total)&&void 0!==i?i:a.length);return a.slice(n,s)}render(t){if(!this.articleContainer)return;const e=[];let i=null;const a=this.observerActive;a&&this.disableObserver(),Array.from(this.articleContainer.children).forEach((a=>{var r;const n=a;if(n.hasAttribute("data-section-static"))e.push(n),n.remove();else if(n.hasAttribute("data-section-render")||!i){if(!i){if(i=n,this.articleTemplate=null!==(r=this.articleTemplate)&&void 0!==r?r:i,!(this.articleTemplate&&this.articleTemplate instanceof HTMLElement))throw new Error("No se pudo encontrar una plantilla válida en el contenedor.");t.forEach((t=>{const i=this.articleTemplate.cloneNode(!0);i.querySelectorAll("*").forEach((e=>{this.processText(e,t),this.processAttrs(e,t),this.assignSrc(e)})),e.push(i)}))}n.remove()}else n.remove()})),e.forEach((t=>this.articleContainer.appendChild(t))),this.articleContainer.setAttribute("data-section-rendered","true"),a&&this.enableObserver(),this.reconnectButtons(),this.updateInfo(),this.updateButtons(),this.articleContainer.dispatchEvent(new CustomEvent("sectionjs:rendered",{detail:{pageData:t}}))}reconnectButtons(){if(!this.articleContainer)return;const t=[...Array.from(this.articleContainer.querySelectorAll('[data-section-static] [data-action="prev"]')),...Array.from(document.querySelectorAll(`[data-target="${this.articleContainer.id}"][data-action="prev"]`))].filter((t=>null!==t)),e=[...Array.from(this.articleContainer.querySelectorAll('[data-section-static] [data-action="next"]')),...Array.from(document.querySelectorAll(`[data-target="${this.articleContainer.id}"][data-action="next"]`))].filter((t=>null!==t));t.forEach((t=>t.onclick=()=>this.paginate("prev"))),e.forEach((t=>t.onclick=()=>this.paginate("next")))}processText(t,e){Array.from(t.childNodes).filter((t=>t.nodeType===Node.TEXT_NODE)).forEach((t=>{t.textContent=this.replaceText(t.textContent||"",e)}))}processAttrs(t,e){Array.from(t.attributes).forEach((i=>{t.setAttribute(i.name,this.replaceText(i.value,e))}))}assignSrc(t){["IMG","AUDIO","VIDEO"].includes(t.tagName)&&t.hasAttribute("data-src")&&t.setAttribute("src",t.getAttribute("data-src"))}replaceText(t,e){return t.replace(/{{(.*?)}}/g,((t,i)=>this.getValue(e,i)||""))}getValue(t,e){return e.split(".").reduce(((t,e)=>t&&"object"==typeof t?t[e]:""),t)}updateInfo(){var t,e,i;if(!this.articleContainer||!this.spanElements.length||!this.infoTemplates.length)return;const a=Math.ceil(((null===(t=this.data)||void 0===t?void 0:t.length)||0)/(this.limit||(null===(e=this.data)||void 0===e?void 0:e.length)||1)),r=(null===(i=this.data)||void 0===i?void 0:i.length)||0,n=this.getPage(this.currentPage).length,s=(this.currentPage-1)*(this.limit||0)+1,o=Math.min(s+(this.limit||0)-1,r);[...Array.from(this.articleContainer.querySelectorAll('[data-section-static] [data-action="info"]')),...Array.from(document.querySelectorAll(`[data-target="${this.articleContainer.id}"][data-action="info"]`))].filter((t=>null!==t)).forEach(((t,e)=>{const i=this.infoTemplates?this.infoTemplates[e]:null,l=i?i.textContent:null;l&&(t.textContent=l.replace("{{pageNow}}",this.currentPage.toString()).replace("{{totalPages}}",a.toString()).replace("{{itemsNow}}",n.toString()).replace("{{itemsTotal}}",r.toString()).replace("{{firstItemIndex}}",s.toString()).replace("{{lastItemIndex}}",o.toString()))}))}updateButtons(){var t,e;if(!this.articleContainer)return;const i=Math.ceil(((null===(t=this.data)||void 0===t?void 0:t.length)||0)/(this.limit||(null===(e=this.data)||void 0===e?void 0:e.length)||1)),a=[...Array.from(this.articleContainer.querySelectorAll('[data-section-static] [data-action="prev"]')),...Array.from(document.querySelectorAll(`[data-target="${this.articleContainer.id}"][data-action="prev"]`))].filter((t=>null!==t)),r=[...Array.from(this.articleContainer.querySelectorAll('[data-section-static] [data-action="next"]')),...Array.from(document.querySelectorAll(`[data-target="${this.articleContainer.id}"][data-action="next"]`))].filter((t=>null!==t));a.forEach((t=>t.disabled=1===this.currentPage)),r.forEach((t=>t.disabled=this.currentPage===i))}refresh(){return t(this,void 0,void 0,(function*(){var t,e;if(!this.articleContainer)return;const i=this.limit,a=this.order,r=this.start,n=this.orderBy,s=this.total,o=this.defaultPage,l=this.dataSourceURL,h=this.findKey;if(this.updateAttrs(),i!==this.limit||a!==this.order||r!==this.start||n!==this.orderBy||s!==this.total||o!==this.defaultPage||l!==this.dataSourceURL||h!==this.findKey){!this.dataSourceURL||s===this.total&&l===this.dataSourceURL||(yield this.load()),h!==this.findKey&&(yield this.findKeyValue()),o!==this.defaultPage&&(this.currentPage=this.defaultPage);const i=Math.ceil(((null===(t=this.data)||void 0===t?void 0:t.length)||0)/(this.limit||(null===(e=this.data)||void 0===e?void 0:e.length)||1));this.currentPage=Math.min(this.currentPage,i),this.render(this.getPage(this.currentPage))}}))}paginate(t){if(!this.articleContainer||!this.data)return;const e=Math.ceil(this.data.length/(this.limit||this.data.length));"prev"===t&&this.currentPage>1?this.currentPage--:"next"===t&&this.currentPage<e&&this.currentPage++,this.render(this.getPage(this.currentPage))}addListener(){this.articleContainer&&this.articleContainer.addEventListener("sectionjs:getdata",(t=>{const e=t.detail.data,i=e&&this.data?this.getValue(this.data,e):this.data;this.articleContainer.dispatchEvent(new CustomEvent(`sectionjs:getdata:${e||"all"}`,{detail:{value:i}}))}))}static initAll(){return t(this,void 0,void 0,(function*(){const t=document.querySelectorAll("[data-section]");if(0!==t.length){SectionJS.instances=[];for(const e of t){const t=new SectionJS(e);SectionJS.instances.push(t),yield t.initSelf()}}}))}initSelf(){return t(this,void 0,void 0,(function*(){var t,e;this.addListener(),yield this.load(),yield this.findKeyValue();const i=Math.ceil(((null===(t=this.data)||void 0===t?void 0:t.length)||0)/(this.limit||(null===(e=this.data)||void 0===e?void 0:e.length)||1));this.currentPage=Math.min(this.currentPage,i);this.articleContainer.hasAttribute("data-section-rendered")||this.render(this.getPage(this.currentPage));const a=document.querySelector(`[data-target="${this.articleContainer.id}"]`),r=null==a?void 0:a.querySelector('button[data-action="prev"]'),n=null==a?void 0:a.querySelector('button[data-action="next"]');r&&(r.onclick=()=>this.paginate("prev")),n&&(n.onclick=()=>this.paginate("next"))}))}static apply(e,i,a){return t(this,void 0,void 0,(function*(){const t=document.getElementById(e);if(t){const e=SectionJS.instances.find((e=>e.articleContainer===t));if(e){const t=e.observerActive;t&&e.disableObserver();e.articleContainer.getAttribute(i)!==a.toString()&&(e.articleContainer.setAttribute(i,a.toString()),yield e.refresh()),t&&e.enableObserver()}}}))}setAttribute(e,i){return t(this,void 0,void 0,(function*(){const t=this.observerActive;t&&this.disableObserver();this.articleContainer.getAttribute(e)!==i.toString()&&(this.articleContainer.setAttribute(e,i.toString()),yield this.refresh()),t&&this.enableObserver()}))}}SectionJS.instances=[];